name: Remote Deploy

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Npm Install
        run: npm i
      - name: Configure SSH connection
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -t rsa ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add - <<< "${{ secrets.SSH_KEY }}"
      - name: Deploy
        run: npm run deploy
        env:
          DOCKER_HOST: ssh://${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT }}
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
          DOCKER_TLS_VERIFY: 1
          DOCKER_CERT: "-----BEGIN CERTIFICATE-----
MIID3zCCAsegAwIBAgIUfXvTcb9YFIamrRYgM39hZdfpMvgwDQYJKoZIhvcNAQEL
BQAwfzELMAkGA1UEBhMCUEwxEzARBgNVBAgMCkRvbG55c2xhc2sxEDAOBgNVBAcM
B1dyb2NsYXcxDjAMBgNVBAoMBUZpbGFyMQwwCgYDVQQLDANmaWwxDDAKBgNVBAMM
A2ZpbDEdMBsGCSqGSIb3DQEJARYOaGVsbG9AZmlsYXIuY28wHhcNMjMxMDE1MDEz
MjQ5WhcNMjQxMDE0MDEzMjQ5WjB/MQswCQYDVQQGEwJQTDETMBEGA1UECAwKRG9s
bnlzbGFzazEQMA4GA1UEBwwHV3JvY2xhdzEOMAwGA1UECgwFRmlsYXIxDDAKBgNV
BAsMA2ZpbDEMMAoGA1UEAwwDZmlsMR0wGwYJKoZIhvcNAQkBFg5oZWxsb0BmaWxh
ci5jbzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALoNBhbDdTffJ6/P
Us8gkJp6RXPAENhbyUEpuCpibB5sHG3vbfj0w6GLJDnojwRIQ2y/vPVGxsZxRtSO
GHaus+lb/QF7tg2Msy/lF/WyTOnulD5O1X738UWJbru7E70ihe6QeLSWIqNpJxwR
L/yI2F3X6QWe7j+2NCl/mhUuOkiEa0epGXQ+VdDMuCKHzcfo+YWqwHqRXxQyMSgc
wUrqxCufENrRrEUwxQctwztWX0H27PSI45u9tPZP+zL/u5uSjcsy1s0PGTx5k+t7
7TqAlKbPxlczoGcEZsq2UMilL4IBDSpzuXqlrcQIBkTfwKg93t5733v8ZAchkY7M
81b5880CAwEAAaNTMFEwHQYDVR0OBBYEFLl+HNboXb7tG9yFH4rKmpJhXkDYMB8G
A1UdIwQYMBaAFLl+HNboXb7tG9yFH4rKmpJhXkDYMA8GA1UdEwEB/wQFMAMBAf8w
DQYJKoZIhvcNAQELBQADggEBAICBdLzVfGU6+/l5Z3DCOcBeTGj1tWTXKaQxap5K
q+qk4SF4ESR13AZWqN1N0jMubLClASwtKsQTcxECecv+j4ETwO1XfwaqTtKyOJCn
td+xtfGtad+R3ioWslMuLeCyV6vKzbNCINMvqQ140Jw0Wn/ffe8fvyX+37av9Yv2
TKcaycDWSl9YOlFswNaOcyf6NHo/1NXTDkBmvxW4RYuep5FWS7kuqrkWV592v5R+
jAyPWj1D8MB95i2rrcHVctHDy2TCgGmNYrttWzPwhNvL9Y9zNZ5ACKxZpfn9joZ+
PGvABIHENRD00RAFSL2Pm9WJaUpibeSrGUzNt9u3E+dBnko=
-----END CERTIFICATE-----"
